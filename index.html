<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Archive</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --primary-color: #3498db;
            --past-color: #e0e0e0;
            --today-color: #fff9c4;
            --future-color: #e8f5e9;
            --text-color: #333;
            --accent-color: #e67e22;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --dark-color: #2c3e50;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1,
        h2,
        h3 {
            text-align: center;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 18px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        button:hover {
            opacity: 0.8;
        }

        .btn-secondary {
            background-color: #7f8c8d;
        }

        .btn-edit {
            background-color: var(--accent-color);
        }

        .btn-delete {
            background-color: var(--danger-color);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.85em;
            background-color: var(--success-color);
        }

        .btn-dark {
            background-color: var(--dark-color);
        }

        .view-section {
            display: none;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .view-section.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        tbody tr:hover {
            filter: brightness(0.95);
        }

        .status-past {
            background-color: var(--past-color);
        }

        .status-today {
            background-color: var(--today-color);
            border-left: 6px solid #f1c40f;
        }

        .status-future {
            background-color: var(--future-color);
            border-left: 6px solid #2ecc71;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        .date-select-group {
            display: flex;
            gap: 10px;
        }

        .date-select-group select {
            flex: 1;
        }

        .quick-add-artist {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .quick-add-artist input {
            flex: 1;
        }

        .checkbox-group {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            background: #fff;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .checkbox-item input {
            width: auto;
            cursor: pointer;
        }

        .artist-tag {
            display: inline-block;
            background: #eee;
            padding: 4px 10px;
            border-radius: 20px;
            margin-right: 8px;
            font-size: 0.9em;
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        .actions {
            margin-top: 25px;
            display: flex;
            gap: 10px;
            justify-content: center;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .stats-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f9f9f9;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: center;
            min-width: 80px;
        }

        .stat-card .num {
            display: block;
            font-size: 1.4em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-card .label {
            font-size: 0.8em;
            color: #666;
        }

        /* 特定の色分け用 */
        .card-past .num {
            color: var(--primary-color);
        }

        .card-future .num {
            color: var(--success-color);
        }

        .empty-state {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .settings-card {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
        }

        .venue-list {
            list-style: none;
            padding: 0;
        }

        .venue-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .venue-info {
            cursor: pointer;
            flex-grow: 1;
            text-align: left;
        }

        .venue-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .venue-pref {
            font-size: 0.8em;
            color: #666;
            margin-right: 10px;
        }

        .sort-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .sort-controls select {
            width: auto;
            padding: 5px;
        }

        .chart-wrapper {
            margin: 20px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 6px;
            height: 150px;
            padding-bottom: 25px;
            border-bottom: 2px solid #ddd;
            margin-top: 10px;
        }

        .bar-column {
            flex: 1;
            display: flex;
            flex-direction: column-reverse;
            position: relative;
            height: 100%;
        }

        .bar-segment {
            width: 100%;
            transition: height 0.3s;
        }

        .segment-past {
            background-color: var(--primary-color);
        }

        .segment-future {
            background-color: var(--success-color);
            opacity: 0.7;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            color: #666;
            width: 100%;
            text-align: center;
        }

        .bar-total {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            font-weight: bold;
        }

        .pref-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .pref-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .ranking-list {
            text-align: left;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 0.9em;
        }

        .rank-num {
            font-weight: bold;
            color: var(--accent-color);
            margin-right: 10px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .formula-hint {
            text-align: right;
            font-size: 0.75em;
            color: #888;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Live Archive</h1>

        <nav>
            <button onclick="showSection('liveListSection')">ライブ一覧</button>
            <button onclick="openLiveForm()">＋ ライブ登録</button>
            <button onclick="renderArtistList(); showSection('artistListSection')">アーティスト</button>
            <button onclick="showSection('otherMenuSection')">その他</button>
            <button onclick="showSection('settingsSection')" class="btn-dark">設定・バックアップ</button>
        </nav>

        <section id="otherMenuSection" class="view-section">
            <h2>その他メニュー</h2>
            <div class="menu-grid">
                <button onclick="renderVenueList(); showSection('venueListSection')">会場一覧</button>
                <button onclick="initStatsView(); showSection('statsSection')">統計</button>
            </div>
        </section>

        <section id="liveListSection" class="view-section active">
            <h2>参加ライブ一覧</h2>
            <div class="stats-container" id="liveListStats"></div>
            <table id="liveTable">
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>公演名</th>
                        <th>アーティスト</th>
                        <th>場所</th>
                    </tr>
                </thead>
                <tbody id="liveTableBody"></tbody>
            </table>
        </section>

        <section id="venueListSection" class="view-section">
            <h2>会場一覧</h2>
            <div class="sort-controls">
                <label><small>並び替え:</small></label>
                <select id="venueSortSelect" onchange="renderVenueList()">
                    <option value="newest">新しい順</option>
                    <option value="frequency">訪問回数順</option>
                </select>
            </div>
            <div id="venueContainer"></div>
            <div class="actions"><button class="btn-secondary" onclick="showSection('otherMenuSection')">戻る</button>
            </div>
        </section>

        <section id="statsSection" class="view-section">
            <h2>統計データ</h2>
            <div class="form-group" style="max-width:200px; margin:0 auto 20px;">
                <label>表示する年</label>
                <select id="statsYearSelect" onchange="updateStats()"></select>
            </div>
            <div class="chart-wrapper">
                <h3>月別参加回数</h3>
                <p style="text-align: center;"><small><span style="color:var(--primary-color)">■</span> 済 / <span
                            style="color:var(--success-color); opacity:0.7;">■</span> 予定</small></p>
                <div id="monthlyChart" class="bar-chart"></div>
            </div>
            <div class="stats-container">
                <div class="stat-card"><span class="num" id="yearlyTotalCount">0</span><span
                        class="label">年間合計参加数</span></div>
            </div>
            <div class="pref-stats-grid">
                <div>
                    <h3>通算 都道府県TOP5</h3>
                    <div id="allTimePrefRanking" class="ranking-list"></div>
                </div>
                <div>
                    <h3>年間 都道府県TOP5</h3>
                    <div id="yearlyPrefRanking" class="ranking-list"></div>
                </div>
            </div>
            <h3>年間お気に入りランキング</h3>
            <div id="yearlyRanking" class="ranking-list" style="max-width: 500px; margin: 0 auto;"></div>
            <h3>年間のライブ一覧</h3>
            <table id="yearlyLiveTable">
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>公演名</th>
                        <th>会場</th>
                    </tr>
                </thead>
                <tbody id="yearlyLiveBody"></tbody>
            </table>
            <div class="actions"><button class="btn-secondary" onclick="showSection('otherMenuSection')">戻る</button>
            </div>
        </section>

        <section id="venueDetailSection" class="view-section">
            <h2 id="detVenueName"></h2>
            <p id="detVenuePref" style="text-align: center; color: #666;"></p>
            <div class="stats-container" id="venueStats"></div>
            <h3>この会場での参加履歴</h3>
            <table id="venueLiveTable">
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>公演名</th>
                        <th>アーティスト</th>
                    </tr>
                </thead>
                <tbody id="venueLiveBody"></tbody>
            </table>
            <div class="actions">
                <button class="btn-secondary" onclick="showSection('venueListSection')">戻る</button>
                <button class="btn-edit" id="editVenueBtn">会場情報を編集</button>
            </div>
        </section>

        <section id="venueEditFormSection" class="view-section">
            <h2>会場編集</h2>
            <form id="venueEditForm">
                <input type="hidden" id="oldVenueName"><input type="hidden" id="oldVenuePref">
                <div class="form-group"><label>会場名</label><input type="text" id="editVenueName" required></div>
                <div class="form-group"><label>都道府県</label><select id="editVenuePrefSelect"></select></div>
                <div class="actions"><button type="button" class="btn-secondary"
                        onclick="showSection('venueListSection')">キャンセル</button><button type="submit">更新する</button>
                </div>
            </form>
        </section>

        <section id="artistListSection" class="view-section">
            <h2>登録アーティスト</h2>
            <div class="sort-controls">
                <select id="artistSortSelect" onchange="renderArtistList()" style="padding:5px;">
                    <option value="regNew">登録順 (新しい順)</option>
                    <option value="favorite">お気に入り順</option>
                </select>
            </div>
            <table id="artistTable">
                <thead>
                    <tr>
                        <th>アーティスト名</th>
                        <th>参加(済/予定)</th>
                        <th>ワンマン</th>
                        <th>対バン</th>
                        <th>フェス</th>
                    </tr>
                </thead>
                <tbody id="artistTableBody"></tbody>
            </table>
            <div id="artistFormulaHint" class="formula-hint">※お気に入り係数 = 5*(ワンマン) + 3*(対バン) + 2*(フェス) + 前後1年のライブ数</div>
        </section>

        <section id="artistDetailSection" class="view-section">
            <h2 id="detArtistName"></h2>
            <div class="stats-container" id="artistStats"></div>
            <h3>参加履歴</h3>
            <table id="artistLiveTable">
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>公演名</th>
                        <th>会場</th>
                    </tr>
                </thead>
                <tbody id="artistLiveBody"></tbody>
            </table>
            <div class="actions"><button class="btn-secondary"
                    onclick="showSection('artistListSection')">戻る</button><button class="btn-edit"
                    id="editArtistBtn">名前を編集</button><button class="btn-delete" id="deleteArtistBtn">アーティストを削除</button>
            </div>
        </section>

        <section id="liveDetailSection" class="view-section">
            <h2 id="detLiveName"></h2>
            <div id="liveDetailContent"></div>
            <div class="actions"><button class="btn-secondary"
                    onclick="showSection('liveListSection')">戻る</button><button class="btn-edit"
                    id="editLiveBtn">編集する</button><button class="btn-delete" id="deleteLiveBtn">削除する</button></div>
        </section>

        <section id="liveFormSection" class="view-section">
            <h2 id="liveFormTitle">ライブ登録</h2>
            <form id="liveForm">
                <input type="hidden" id="editLiveId">
                <div class="form-group"><label>公演名</label><input type="text" id="liveName" required></div>
                <div class="form-group"><label>日付</label>
                    <div class="date-select-group"><select id="yearSelect" onchange="updateDays()"></select><select
                            id="monthSelect" onchange="updateDays()"></select><select id="daySelect"></select></div>
                </div>
                <div class="form-group"><label>都道府県</label><select id="prefecture"
                        onchange="updateVenueSuggestions()"></select></div>
                <div class="form-group"><label>会場名</label><input type="text" id="venueName" list="venueSuggestions"
                        required><datalist id="venueSuggestions"></datalist></div>
                <div class="form-group"><label>形式</label><select id="liveType">
                        <option value="ワンマン">ワンマン</option>
                        <option value="対バン">対バン</option>
                        <option value="フェス">フェス</option>
                    </select></div>
                <div class="form-group">
                    <label>アーティスト選択</label>
                    <div class="quick-add-artist"><input type="text" id="quickArtistName"
                            placeholder="新しいアーティスト名"><button type="button" class="btn-small"
                            onclick="quickAddArtist()">追加</button></div>
                    <div id="artistCheckboxes" class="checkbox-group"></div>
                </div>
                <div class="actions"><button type="button" class="btn-secondary"
                        onclick="showSection('liveListSection')">キャンセル</button><button type="submit">保存する</button></div>
            </form>
        </section>

        <section id="artistEditFormSection" class="view-section">
            <h2>アーティスト名編集</h2>
            <form id="artistEditForm"><input type="hidden" id="editArtistId">
                <div class="form-group"><label>アーティスト名</label><input type="text" id="editArtistName" required></div>
                <div class="actions"><button type="button" class="btn-secondary"
                        onclick="showSection('artistListSection')">キャンセル</button><button type="submit">保存する</button>
                </div>
            </form>
        </section>

        <section id="settingsSection" class="view-section">
            <h2>設定・バックアップ</h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>エクスポート</h3><button onclick="exportJSON()"
                        style="width:100%; margin-bottom:10px;">JSON形式で保存</button><button onclick="exportCSV()"
                        class="btn-secondary" style="width:100%;">CSV形式で保存</button>
                </div>
                <div class="settings-card">
                    <h3>インポート</h3><input type="file" id="importFile" accept=".json" style="margin-bottom:10px;"><button
                        onclick="importJSON()" class="btn-edit" style="width:100%;">復元</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        let lives = JSON.parse(localStorage.getItem('lives')) || [];
        let artists = JSON.parse(localStorage.getItem('artists')) || [];
        const todayStr = new Date().toISOString().split('T')[0];

        const prefectures = ["北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県", "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県", "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県", "静岡県", "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県", "奈良県", "和歌山県", "鳥取県", "島根県", "岡山県", "広島県", "山口県", "徳島県", "香川県", "愛媛県", "高知県", "福岡県", "佐賀県", "長崎県", "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"];

        function init() {
            const prefSelect = document.getElementById('prefecture');
            const editPrefSelect = document.getElementById('editVenuePrefSelect');
            prefectures.forEach(p => {
                let opt = document.createElement('option'); opt.value = p; opt.textContent = p;
                prefSelect.appendChild(opt); editPrefSelect.appendChild(opt.cloneNode(true));
            });
            initDateSelects();
            renderLiveList();
        }

        function showSection(sectionId) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        function getDefaultPrefecture() {
            if (lives.length === 0) return "東京都";
            const counts = {};
            lives.forEach(l => counts[l.pref] = (counts[l.pref] || 0) + 1);
            return Object.entries(counts).sort((a, b) => b[1] - a[1])[0][0];
        }

        // --- タイ（同順位）対応のランキング表示用 ---
        function renderTieRanking(elementId, dataArray, unit = "回") {
            const div = document.getElementById(elementId);
            if (!dataArray.length) { div.innerHTML = 'なし'; return; }

            let html = '';
            let currentRank = 1;
            for (let i = 0; i < dataArray.length; i++) {
                // 前の項目とスコアが違う場合のみ順位を更新（1, 2, 2, 4 の形式）
                if (i > 0 && dataArray[i][1] < dataArray[i - 1][1]) {
                    currentRank = i + 1;
                }
                html += `<div class="ranking-item"><span>${currentRank}. ${dataArray[i][0]}</span><span>${dataArray[i][1]}${unit}</span></div>`;
            }
            div.innerHTML = html;
        }

        function initStatsView() {
            const yearSelect = document.getElementById('statsYearSelect');
            yearSelect.innerHTML = '';
            const years = [...new Set(lives.map(l => l.date.split('-')[0]))].sort((a, b) => b - a);
            if (years.length === 0) years.push(new Date().getFullYear());
            years.forEach(y => { const opt = document.createElement('option'); opt.value = y; opt.textContent = y + '年'; yearSelect.appendChild(opt); });
            updateStats();
        }

        function updateStats() {
            const targetYear = document.getElementById('statsYearSelect').value;
            const yearlyLives = lives.filter(l => l.date.startsWith(targetYear)).sort((a, b) => b.date.localeCompare(a.date));
            document.getElementById('yearlyTotalCount').textContent = yearlyLives.length;

            const mPast = new Array(12).fill(0); const mFuture = new Array(12).fill(0);
            yearlyLives.forEach(l => { const m = parseInt(l.date.split('-')[1]) - 1; if (l.date < todayStr) mPast[m]++; else mFuture[m]++; });
            const maxVal = Math.max(...mPast.map((v, i) => v + mFuture[i]), 1);
            const chart = document.getElementById('monthlyChart'); chart.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const col = document.createElement('div'); col.className = 'bar-column';
                const pastH = (mPast[i] / maxVal) * 100; const futureH = (mFuture[i] / maxVal) * 100;
                col.innerHTML = `<div class="bar-segment segment-past" style="height:${pastH}%"></div><div class="bar-segment segment-future" style="height:${futureH}%"></div><span class="bar-total">${(mPast[i] + mFuture[i]) || ''}</span><span class="bar-label">${i + 1}月</span>`;
                chart.appendChild(col);
            }

            const getRank = (arr, fn) => { const c = {}; arr.forEach(x => { const k = fn(x); c[k] = (c[k] || 0) + 1; }); return Object.entries(c).sort((a, b) => b[1] - a[1]).slice(0, 5); };
            renderTieRanking('allTimePrefRanking', getRank(lives, l => l.pref), "回");
            renderTieRanking('yearlyPrefRanking', getRank(yearlyLives, l => l.pref), "回");

            const rankMap = {};
            yearlyLives.forEach(l => { l.artistIds.forEach(id => { const s = l.type === 'ワンマン' ? 5 : l.type === '対バン' ? 3 : 2; rankMap[id] = (rankMap[id] || 0) + s; }); });
            const favData = Object.entries(rankMap).sort((a, b) => b[1] - a[1]).slice(0, 10).map(r => [artists.find(a => String(a.id) === String(r[0]))?.name || '<削除済>', r[1]]);
            renderTieRanking('yearlyRanking', favData, " pt");

            document.getElementById('yearlyLiveBody').innerHTML = yearlyLives.map(l => `<tr class="${l.date < todayStr ? 'status-past' : (l.date === todayStr ? 'status-today' : 'status-future')}" onclick="showLiveDetail('${l.id}')"><td>${l.date}</td><td>${l.name}</td><td>${l.venue}</td></tr>`).join('') || '<tr><td colspan="3">なし</td></tr>';
        }

        function renderLiveList() {
            const body = document.getElementById('liveTableBody');
            lives.sort((a, b) => b.date.localeCompare(a.date));
            const pastCount = lives.filter(l => l.date < todayStr).length;
            const futureCount = lives.filter(l => l.date >= todayStr).length;

            // タイトル横の文字を消し、カード枠に表示
            const statsDiv = document.getElementById('liveListStats');
            statsDiv.innerHTML = `
            <div class="stat-card card-past"><span class="num">${pastCount}</span><span class="label">参加済</span></div>
            <div class="stat-card card-future"><span class="num">${futureCount}</span><span class="label">参加予定</span></div>
        `;

            body.innerHTML = lives.map(l => {
                const cls = l.date < todayStr ? 'status-past' : (l.date === todayStr ? 'status-today' : 'status-future');
                const arts = l.artistIds.map(id => artists.find(a => String(a.id) === String(id))?.name || '<削除済>').join(', ');
                return `<tr class="${cls}" onclick="showLiveDetail('${l.id}')"><td>${l.date}</td><td><strong>${l.name}</strong><br><small>(${l.type})</small></td><td>${arts}</td><td>${l.pref} ${l.venue}</td></tr>`;
            }).join('') || '<tr><td colspan="4">登録なし</td></tr>';
        }

        function renderArtistList() {
            const sort = document.getElementById('artistSortSelect').value;
            const hint = document.getElementById('artistFormulaHint');
            // お気に入り順の時だけヒントを表示
            hint.style.display = (sort === 'favorite') ? 'block' : 'none';

            const sorted = [...artists];
            if (sort === 'regNew') sorted.sort((a, b) => Number(b.id) - Number(a.id));
            else sorted.sort((a, b) => calculateFavoriteScore(b.id) - calculateFavoriteScore(a.id));
            document.getElementById('artistTableBody').innerHTML = sorted.map(a => {
                const s = getArtistStats(a.id);
                return `<tr onclick="showArtistDetail('${a.id}')"><td><strong style="color:var(--primary-color)">${a.name}</strong></td><td>${s.past}/${s.future}</td><td>${s.oneman}</td><td>${s.taiban}</td><td>${s.fes}</td></tr>`;
            }).join('') || '<tr><td colspan="5">なし</td></tr>';
        }

        function renderVenueList() {
            const sort = document.getElementById('venueSortSelect').value;
            const vMap = {};
            lives.forEach(l => {
                const k = `${l.pref}|${l.venue}`;
                if (!vMap[k]) vMap[k] = { name: l.venue, pref: l.pref, count: 0, last: l.date };
                if (l.date < todayStr) vMap[k].count++;
                if (l.date > vMap[k].last) vMap[k].last = l.date;
            });
            const sorted = Object.values(vMap).sort((a, b) => sort === 'newest' ? b.last.localeCompare(a.last) : (b.count - a.count || b.last.localeCompare(a.last)));
            document.getElementById('venueContainer').innerHTML = `<ul class="venue-list">` + sorted.map(v => `<li class="venue-item"><div class="venue-info" onclick="showVenueDetail('${v.pref}','${v.name}')"><span class="venue-pref">${v.pref}</span> <span class="venue-name">${v.name}</span></div><span class="stat-card btn-small">${v.count}回</span></li>`).join('') + `</ul>`;
        }

        function showVenueDetail(pref, name) {
            document.getElementById('detVenueName').textContent = name;
            document.getElementById('detVenuePref').textContent = pref;
            const history = lives.filter(l => l.venue === name && l.pref === pref).sort((a, b) => b.date.localeCompare(a.date));
            const pastCount = history.filter(l => l.date < todayStr).length;
            document.getElementById('venueStats').innerHTML = `<div class="stat-card"><span class="num">${pastCount}</span><span class="label">Total (参加済)</span></div>`;
            document.getElementById('venueLiveBody').innerHTML = history.map(l => {
                const cls = l.date < todayStr ? 'status-past' : (l.date === todayStr ? 'status-today' : 'status-future');
                const arts = l.artistIds.map(id => artists.find(a => String(a.id) === String(id))?.name || '<削除済>').join(', ');
                return `<tr class="${cls}" onclick="showLiveDetail('${l.id}')"><td>${l.date}</td><td>${l.name}</td><td>${arts}</td></tr>`;
            }).join('');
            document.getElementById('editVenueBtn').onclick = () => {
                document.getElementById('oldVenueName').value = name; document.getElementById('oldVenuePref').value = pref;
                document.getElementById('editVenueName').value = name; document.getElementById('editVenuePrefSelect').value = pref;
                showSection('venueEditFormSection');
            };
            showSection('venueDetailSection');
        }

        function showArtistDetail(id) {
            const a = artists.find(x => String(x.id) === String(id)); if (!a) return;
            document.getElementById('detArtistName').textContent = a.name;
            const s = getArtistStats(id);
            document.getElementById('artistStats').innerHTML = `<div class="stat-card"><span class="num">${s.past}</span><span class="label">Total (参加済)</span></div><div class="stat-card"><span class="num">${s.oneman}</span><span class="label">ワンマン</span></div><div class="stat-card"><span class="num">${s.taiban}</span><span class="label">対バン</span></div><div class="stat-card"><span class="num">${s.fes}</span><span class="label">フェス</span></div>`;
            const hist = lives.filter(l => l.artistIds.some(aid => String(aid) === String(id))).sort((a, b) => b.date.localeCompare(a.date));
            document.getElementById('artistLiveBody').innerHTML = hist.map(l => `<tr class="${l.date < todayStr ? 'status-past' : (l.date === todayStr ? 'status-today' : 'status-future')}" onclick="showLiveDetail('${l.id}')"><td>${l.date}</td><td>${l.name}</td><td>${l.venue}</td></tr>`).join('');
            document.getElementById('editArtistBtn').onclick = () => { document.getElementById('editArtistId').value = id; document.getElementById('editArtistName').value = a.name; showSection('artistEditFormSection'); };
            document.getElementById('deleteArtistBtn').onclick = () => { if (confirm('削除しますか？')) { artists = artists.filter(x => String(x.id) !== String(id)); lives.forEach(l => l.artistIds = l.artistIds.filter(aid => String(aid) !== String(id))); saveData(); renderArtistList(); showSection('artistListSection'); } };
            showSection('artistDetailSection');
        }

        function getArtistStats(artistId) {
            const hist = lives.filter(l => l.artistIds.some(id => String(id) === String(artistId)));
            return {
                past: hist.filter(l => l.date < todayStr).length,
                future: hist.filter(l => l.date >= todayStr).length,
                oneman: hist.filter(l => l.date < todayStr && l.type === 'ワンマン').length,
                taiban: hist.filter(l => l.date < todayStr && l.type === '対バン').length,
                fes: hist.filter(l => l.date < todayStr && l.type === 'フェス').length
            };
        }

        function calculateFavoriteScore(artistId) {
            const now = new Date(); const s = new Date(); s.setFullYear(now.getFullYear() - 1); const e = new Date(); e.setFullYear(now.getFullYear() + 1);
            const startStr = s.toISOString().split('T')[0]; const endStr = e.toISOString().split('T')[0];
            let score = 0; let rangeCount = 0;
            lives.filter(l => l.artistIds.some(id => String(id) === String(artistId))).forEach(l => {
                score += l.type === 'ワンマン' ? 5 : l.type === '対バン' ? 3 : 2;
                if (l.date >= startStr && l.date <= endStr) rangeCount++;
            });
            return score + rangeCount;
        }

        function openLiveForm(id = null) {
            const f = document.getElementById('liveForm'); f.reset(); let sel = [];
            if (id) {
                const l = lives.find(x => x.id === id); document.getElementById('editLiveId').value = id; document.getElementById('liveName').value = l.name;
                const [y, m, d] = l.date.split('-').map(Number); document.getElementById('yearSelect').value = y; document.getElementById('monthSelect').value = m; updateDays(); document.getElementById('daySelect').value = d;
                document.getElementById('prefecture').value = l.pref; document.getElementById('venueName').value = l.venue; document.getElementById('liveType').value = l.type; sel = l.artistIds;
            } else {
                document.getElementById('editLiveId').value = ""; const n = new Date(); document.getElementById('yearSelect').value = n.getFullYear(); document.getElementById('monthSelect').value = n.getMonth() + 1; updateDays(); document.getElementById('daySelect').value = n.getDate();
                document.getElementById('prefecture').value = getDefaultPrefecture();
            }
            updateVenueSuggestions(); renderArtistCheckboxes(sel); showSection('liveFormSection');
        }

        function initDateSelects() {
            const ys = document.getElementById('yearSelect'); const y = new Date().getFullYear();
            for (let i = y - 10; i <= y + 5; i++) { const o = document.createElement('option'); o.value = i; o.textContent = i + '年'; if (i === y) o.selected = true; ys.appendChild(o); }
            const ms = document.getElementById('monthSelect'); const m = new Date().getMonth() + 1;
            for (let i = 1; i <= 12; i++) { const o = document.createElement('option'); o.value = i; o.textContent = i + '月'; if (i === m) o.selected = true; ms.appendChild(o); }
            updateDays();
        }
        function updateDays() {
            const y = parseInt(document.getElementById('yearSelect').value); const m = parseInt(document.getElementById('monthSelect').value);
            const ds = document.getElementById('daySelect'); const last = new Date(y, m, 0).getDate(); const cur = parseInt(ds.value) || new Date().getDate();
            ds.innerHTML = ''; for (let i = 1; i <= last; i++) { const o = document.createElement('option'); o.value = i; o.textContent = i + '日'; if (i === cur || (i === last && cur > last)) o.selected = true; ds.appendChild(o); }
        }
        function updateVenueSuggestions() {
            const p = document.getElementById('prefecture').value; const dl = document.getElementById('venueSuggestions');
            dl.innerHTML = '';[...new Set(lives.filter(l => l.pref === p).map(l => l.venue))].forEach(v => { const o = document.createElement('option'); o.value = v; dl.appendChild(o); });
        }
        function renderArtistCheckboxes(sel = []) {
            const c = document.getElementById('artistCheckboxes'); c.innerHTML = '';
            artists.sort((a, b) => a.name.localeCompare(b.name, 'ja')).forEach(a => {
                const d = document.createElement('div'); d.className = 'checkbox-item';
                d.innerHTML = `<input type="checkbox" id="cb-${a.id}" value="${a.id}" ${sel.some(id => String(id) === String(a.id)) ? 'checked' : ''}><label for="cb-${a.id}">${a.name}</label>`;
                c.appendChild(d);
            });
        }
        function quickAddArtist() {
            const n = document.getElementById('quickArtistName').value.trim(); if (!n) return;
            const a = { id: Date.now().toString(), name: n }; artists.push(a); saveData(); document.getElementById('quickArtistName').value = '';
            const sel = Array.from(document.querySelectorAll('#artistCheckboxes input:checked')).map(cb => cb.value); sel.push(a.id); renderArtistCheckboxes(sel);
        }
        document.getElementById('liveForm').onsubmit = function (e) {
            e.preventDefault(); const aid = Array.from(document.querySelectorAll('#artistCheckboxes input:checked')).map(cb => cb.value);
            const id = document.getElementById('editLiveId').value; const d = `${document.getElementById('yearSelect').value}-${document.getElementById('monthSelect').value.padStart(2, '0')}-${document.getElementById('daySelect').value.padStart(2, '0')}`;
            const lData = { id: id || Date.now().toString(), name: document.getElementById('liveName').value, date: d, venue: document.getElementById('venueName').value, pref: document.getElementById('prefecture').value, artistIds: aid, type: document.getElementById('liveType').value };
            if (id) { const i = lives.findIndex(x => x.id === id); lives[i] = lData; } else lives.push(lData);
            saveData(); renderLiveList(); showSection('liveListSection');
        };
        function showLiveDetail(id) {
            const l = lives.find(x => x.id === id); if (!l) return;
            const arts = l.artistIds.map(aid => { const a = artists.find(x => String(x.id) === String(aid)); return a ? `<span class="artist-tag" onclick="event.stopPropagation(); showArtistDetail('${aid}')">${a.name}</span>` : `(削除済)`; }).join('');
            document.getElementById('detLiveName').textContent = l.name;
            document.getElementById('liveDetailContent').innerHTML = `<p>日付: ${l.date}</p><p>会場: <span style="color:var(--primary-color); cursor:pointer; text-decoration:underline;" onclick="showVenueDetail('${l.pref}','${l.venue}')">${l.pref} ${l.venue}</span></p><p>形式: ${l.type}</p><div style="margin-top:15px;">アーティスト:<br>${arts}</div>`;
            document.getElementById('editLiveBtn').onclick = () => openLiveForm(id);
            document.getElementById('deleteLiveBtn').onclick = () => { if (confirm('削除しますか？')) { lives = lives.filter(x => x.id !== id); saveData(); renderLiveList(); showSection('liveListSection'); } };
            showSection('liveDetailSection');
        }
        function saveData() { localStorage.setItem('lives', JSON.stringify(lives)); localStorage.setItem('artists', JSON.stringify(artists)); }
        function exportJSON() { const b = new Blob([JSON.stringify({ lives, artists }, null, 2)], { type: 'application/json' }); const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `live_archive.json`; a.click(); }
        function exportCSV() { let c = "\uFEFF日付,公演名,形式,都道府県,会場,アーティスト\n"; lives.forEach(l => { const as = l.artistIds.map(id => artists.find(a => String(a.id) === String(id))?.name || '(削除済)').join('/'); c += `"${l.date}","${l.name}","${l.type}","${l.pref}","${l.venue}","${as}"\n`; }); const b = new Blob([c], { type: 'text/csv' }); const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `live_list.csv`; a.click(); }
        function importJSON() { const f = document.getElementById('importFile').files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { const d = JSON.parse(e.target.result); lives = d.lives; artists = d.artists; saveData(); location.reload(); }; r.readAsText(f); }

        init();
    </script>
</body>

</html>